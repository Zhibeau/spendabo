rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    function isValidTimestamp(value) {
      return value is timestamp;
    }

    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // Users collection: users can read/write their own document
    match /users/{uid} {
      allow read: if isOwner(uid);

      allow create: if isOwner(uid)
        && request.resource.data.uid == uid
        && request.resource.data.email is string
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);

      allow update: if isOwner(uid)
        && request.resource.data.uid == resource.data.uid  // UID immutable
        && isValidTimestamp(request.resource.data.updatedAt);

      allow delete: if isOwner(uid);
    }

    // Accounts collection: users can read/write their own accounts
    match /accounts/{accountId} {
      allow read: if isAuthenticated()
        && resource.data.uid == request.auth.uid;

      allow create: if isAuthenticated()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.accountId == accountId
        && request.resource.data.name is string
        && request.resource.data.type is string
        && request.resource.data.currency is string
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);

      allow update: if isAuthenticated()
        && resource.data.uid == request.auth.uid
        && request.resource.data.uid == resource.data.uid  // UID immutable
        && request.resource.data.accountId == resource.data.accountId  // ID immutable
        && isValidTimestamp(request.resource.data.updatedAt);

      allow delete: if isAuthenticated()
        && resource.data.uid == request.auth.uid;
    }

    // Transactions collection: users can read/write their own transactions
    match /transactions/{txId} {
      allow read: if isAuthenticated()
        && resource.data.uid == request.auth.uid;

      allow create: if isAuthenticated()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.txId == txId
        && request.resource.data.accountId is string
        && request.resource.data.amount is number
        && request.resource.data.currency is string
        && request.resource.data.description is string
        && isValidTimestamp(request.resource.data.postedAt)
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);

      allow update: if isAuthenticated()
        && resource.data.uid == request.auth.uid
        && request.resource.data.uid == resource.data.uid  // UID immutable
        && request.resource.data.txId == resource.data.txId  // ID immutable
        && isValidTimestamp(request.resource.data.updatedAt);

      allow delete: if isAuthenticated()
        && resource.data.uid == request.auth.uid;
    }

    // Categories collection: default categories are read-only, custom categories owned by user
    match /categories/{categoryId} {
      // Anyone authenticated can read default categories
      allow read: if isAuthenticated()
        && (resource.data.isDefault == true
            || resource.data.uid == request.auth.uid);

      // Users can create their own custom categories
      allow create: if isAuthenticated()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.categoryId == categoryId
        && request.resource.data.name is string
        && request.resource.data.isDefault == false
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);

      // Users can update only their own custom categories (not defaults)
      allow update: if isAuthenticated()
        && resource.data.uid == request.auth.uid
        && resource.data.isDefault == false
        && request.resource.data.uid == resource.data.uid  // UID immutable
        && request.resource.data.categoryId == resource.data.categoryId  // ID immutable
        && request.resource.data.isDefault == false  // Can't become default
        && isValidTimestamp(request.resource.data.updatedAt);

      // Users can delete only their own custom categories (not defaults)
      allow delete: if isAuthenticated()
        && resource.data.uid == request.auth.uid
        && resource.data.isDefault == false;
    }

    // Rules collection: users can read/write their own categorization rules
    match /rules/{ruleId} {
      allow read: if isAuthenticated()
        && resource.data.uid == request.auth.uid;

      allow create: if isAuthenticated()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.ruleId == ruleId
        && request.resource.data.field is string
        && request.resource.data.operator is string
        && request.resource.data.categoryId is string
        && request.resource.data.priority is number
        && request.resource.data.enabled is bool
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);

      allow update: if isAuthenticated()
        && resource.data.uid == request.auth.uid
        && request.resource.data.uid == resource.data.uid  // UID immutable
        && request.resource.data.ruleId == resource.data.ruleId  // ID immutable
        && isValidTimestamp(request.resource.data.updatedAt);

      allow delete: if isAuthenticated()
        && resource.data.uid == request.auth.uid;
    }

    // Imports collection: users can read/write their own imports
    match /imports/{importId} {
      allow read: if isAuthenticated()
        && resource.data.uid == request.auth.uid;

      allow create: if isAuthenticated()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.importId == importId
        && request.resource.data.accountId is string
        && request.resource.data.fileName is string
        && request.resource.data.fileSize is number
        && request.resource.data.storagePath is string
        && request.resource.data.status is string
        && isValidTimestamp(request.resource.data.createdAt);

      allow update: if isAuthenticated()
        && resource.data.uid == request.auth.uid
        && request.resource.data.uid == resource.data.uid  // UID immutable
        && request.resource.data.importId == resource.data.importId;  // ID immutable

      allow delete: if isAuthenticated()
        && resource.data.uid == request.auth.uid;
    }
  }
}
